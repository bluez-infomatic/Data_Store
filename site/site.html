<!-- Filename: client-database.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Client Database Clone</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Litepicker CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />

  <style>
    td[contenteditable]:empty:before {
      content: attr(data-placeholder);
      color: #aaa;
      pointer-events: none;
    }
      /* Excel-like table look */
  #clientTable td, #clientTable th {
    border: 1px solid #d1d5db; /* Tailwind gray-300 */
    white-space: nowrap;
    vertical-align: middle;
  }

  #clientTable tbody tr:hover {
    background-color: #f1f5f9; /* Tailwind slate-100 */
  }

  #clientTable input {
    background-color: transparent;
  }
   .transition-max-height {
      transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out;
      overflow: hidden;
    }
    .collapsed {
      max-height: 0;
      opacity: 0;
      pointer-events: none;
    }
    .expanded {
      max-height: 200px; /* Adjust if your filter panel is taller */
      opacity: 1;
      pointer-events: auto;
    }
  
  </style>
</head>

<body class="bg-gray-100 text-sm">
  <!-- Green Tab Bar -->
  <div class="flex flex-wrap items-center gap-2 text-white px-4 py-2" style="background-color: rgb(4, 158, 56);">
    <button class="bg-green-700 px-3 py-1 rounded text-xs sm:text-sm">Client Database</button>
    <div class="ml-auto flex gap-2 flex-wrap">
      <button id="deleteSelectedBtn" class="px-3 py-1 bg-green-700 rounded text-xs sm:text-sm">Delete▼</button>
      <button id="downloadBtn" class="px-3 py-1 bg-lime-500 hover:bg-lime-600 rounded text-xs sm:text-sm">⬇ Download All</button>
    </div>
  </div>

  <!-- Search and Filter -->
 <div class="flex flex-wrap sm:flex-nowrap items-center px-4 py-2 bg-white border-b gap-2">
    <h4 class="text-lg font-semibold text-lime-600 ">Client database stores customer info.</h4>

    
    <button id="filterBtn" class="px-3 py-1 text-sm border rounded bg-white hover:bg-gray-50 flex items-center gap-1">
      Filter <span id="arrow">▼</span>
    </button>
  </div>

  <!-- Filter Panel -->
  <div id="filterPanel" class="transition-max-height collapsed bg-white px-4 py-3 border-b flex-wrap gap-4 items-end flex">
    <div class="flex flex-col">
      <label for="filterName" class="text-xs mb-1">Client Name</label>
      <input type="text" id="filterName" placeholder="Client Name" class="border px-2 py-1 rounded w-48" />
    </div>
    <div class="flex flex-col">
      <label for="filterStartDate" class="text-xs mb-1">Start Date</label>
      <input type="date" id="filterStartDate" class="border px-2 py-1 rounded w-48" />
    </div>
    <div class="flex flex-col">
      <label for="filterEndDate" class="text-xs mb-1">End Date</label>
      <input type="date" id="filterEndDate" class="border px-2 py-1 rounded w-48" />
    </div>
    <div class="flex gap-2 mt-2 sm:mt-0">
      <button id="applyFilterBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">Apply Filter</button>
      <button id="clearFilterBtn" class="bg-gray-300 hover:bg-gray-400 text-black px-3 py-1 rounded text-sm">Clear</button>
    </div>
  </div>
  <!-- Table -->
<!-- Table -->
<div class="overflow-x-auto mt-2 px-4">
  <table id="clientTable" class="min-w-full border border-gray-300 text-sm table-fixed">
    <thead class="bg-gray-100 text-gray-800 border-b border-gray-300">
      <tr>
        <th class="border border-gray-300 p-2 text-center bg-gray-200"><input id="selectAllCheckbox" type="checkbox" class="w-5 h-5 cursor-pointer" /></th>
        <th class="border border-gray-300 p-2 text-center bg-gray-200">S.no</th>
        <th class="border border-gray-300 p-2 text-left bg-gray-200">Client Name</th>
        <th class="border border-gray-300 p-2 text-left bg-gray-200">Date</th>
        <th class="border border-gray-300 p-2 text-left bg-gray-200">Amount</th>
        <th class="border border-gray-300 p-2 text-center bg-gray-200">Replace Amount</th>
      </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">
      <!-- Rows populated dynamically -->
    </tbody>
    <tfoot class="bg-gray-100 font-medium border-t border-gray-300">
      <tr>
        <td colspan="4" class="border border-gray-300 p-2 text-center bg-gray-50">Total</td>
        <td id="totalAmount" class="border border-gray-300 p-2 text-left bg-gray-50">0.00</td>
        <td class="border border-gray-300 p-2 bg-gray-50"></td>
      </tr>
    </tfoot>
  </table>
</div>


  <!-- Add Row -->
  <div class="px-4 py-3 bg-white border-t border-gray-200">
    <button id="addRowBtn" class="px-4 py-1 text-sm hover:bg-gray-300 rounded text-white font-semibold" style="background-color: rgb(4, 158, 56);">
      <span class="font-semibold text-white">+</span> ADD
    </button>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
  <script>
    dayjs.extend(dayjs_plugin_customParseFormat);

    const clients = JSON.parse(localStorage.getItem('clientData')) || [];
    const tbody = document.querySelector("#clientTable tbody");
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');

    function formatToInputDate(dateStr) {
      if (!dateStr) return '';
      const d = dayjs(dateStr, 'DD-MM-YYYY');
      return d.isValid() ? d.format('YYYY-MM-DD') : '';
    }

    function formatDisplayDate(inputDateStr) {
      const d = dayjs(inputDateStr);
      return d.isValid() ? d.format('DD-MM-YYYY') : '';
    }

function createRow(data) {
  const amountValue = (data.amount && data.amount !== 0) ? data.amount : '';
  const row = document.createElement("tr");
  row.innerHTML = `
    <td class="border p-2 text-center"><input type="checkbox" class="w-5 h-5 cursor-pointer" /></td>
    <td class="border p-2 text-center row-number"></td>
    <td class="border p-2"><input type="text" value="${data.name || ''}" placeholder="Client Name" class="border-none outline-none w-full" /></td>
    <td class="border p-2"><input type="date" value="${formatToInputDate(data.date)}" class="border px-2 py-1 rounded w-full sm:w-40"/></td>
    <td class="border p-2"><input type="number" step="0.01" value="${amountValue}" placeholder="Amount" class="border-none outline-none w-full text-left" /></td>
    <td class="border p-2 text-center"><button type="button" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded replace-btn">Replace</button></td>
  `;
  return row;
}
    function updateRowNumbers() {
      const rows = tbody.querySelectorAll("tr");
      rows.forEach((row, index) => {
        row.querySelector(".row-number").textContent = index + 1;
      });
    }

    function updateTotal() {
      let total = 0;
      tbody.querySelectorAll("tr").forEach(row => {
        const amountInput = row.querySelector("td:nth-child(5) input");
        total += parseFloat(amountInput.value) || 0;
      });
      document.getElementById("totalAmount").textContent = total.toFixed(2);
      saveDataToLocalStorage();
    }

    function saveDataToLocalStorage() {
      const data = [];
      tbody.querySelectorAll("tr").forEach(row => {
        const inputs = row.querySelectorAll("input[type=text], input[type=date], input[type=number]");
        data.push({
          name: inputs[0].value.trim(),
          date: dayjs(inputs[1].value).format("DD-MM-YYYY"),
          amount: parseFloat(inputs[2].value) || 0
        });
      });
      localStorage.setItem('clientData', JSON.stringify(data));
    }

    function addRow(data = {}) {
      const row = createRow(data);
      tbody.appendChild(row);
      updateRowNumbers();
      updateTotal();
    }

    function loadRows() {
      tbody.innerHTML = '';
      if (clients.length === 0) {
        addRow();
      } else {
        clients.forEach(data => addRow(data));
      }
    }

    // Replace Amount
    tbody.addEventListener("click", e => {
      if (e.target.classList.contains("replace-btn")) {
        const row = e.target.closest("tr");
        const amountInput = row.querySelector("td:nth-child(5) input");
        const currentAmount = parseFloat(amountInput.value) || 0;

        Swal.fire({
          title: 'Adjust Amount',
          html: `<p>Current amount: <b>${currentAmount.toFixed(2)}</b></p><p>Enter a number to add or subtract (e.g., 100, -50):</p>`,
          input: 'text',
          showCancelButton: true,
          confirmButtonText: 'Apply',
          inputValidator: (value) => {
            const num = parseFloat(value);
            if (isNaN(num)) return 'Enter a valid number!';
            if (currentAmount + num < 0) return 'Resulting amount cannot be negative!';
            return null;
          }
        }).then(result => {
          if (result.isConfirmed) {
            const delta = parseFloat(result.value);
            const newAmount = currentAmount + delta;
            amountInput.value = newAmount.toFixed(2);
            updateTotal();
            Swal.fire({ icon: 'success', title: 'Amount Updated', timer: 1200, toast: true, position: 'top-end', showConfirmButton: false });
          }
        });
      }
    });

    // Select all checkboxes
    selectAllCheckbox.addEventListener('change', () => {
      const checked = selectAllCheckbox.checked;
      tbody.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = checked);
    });

    // Delete rows
    document.getElementById('deleteSelectedBtn').addEventListener('click', () => {
      const selected = [...tbody.querySelectorAll('input[type=checkbox]:checked')];
      if (selected.length === 0) return Swal.fire('No rows selected', '', 'info');
      Swal.fire({ title: `Delete ${selected.length} selected row(s)?`, icon: 'warning', showCancelButton: true, confirmButtonText: 'Delete' })
        .then(res => {
          if (res.isConfirmed) {
            selected.forEach(cb => cb.closest('tr').remove());
            updateRowNumbers();
            updateTotal();
            saveDataToLocalStorage();
            selectAllCheckbox.checked = false;
          }
        });
    });

    document.getElementById('addRowBtn').addEventListener('click', () => addRow());

    tbody.addEventListener('input', () => {
      updateTotal();
    });

  document.getElementById('downloadBtn').addEventListener('click', () => {
  const wb = XLSX.utils.book_new();
  const data = [["S.no", "Client Name", "Date", "Amount"]];

  const rows = tbody.querySelectorAll('tr');
  rows.forEach((row, index) => {
    if (row.style.display === "none") return;
    const inputs = row.querySelectorAll("input[type=text], input[type=date], input[type=number]");
    const formattedDate = dayjs(inputs[1].value).format("DD-MM-YYYY");
    data.push([
      index + 1,
      inputs[0].value,
      formattedDate,
      parseFloat(inputs[2].value) || 0
    ]);
  });

  // Add empty row before total (optional)
  data.push(["", "", "", ""]);

  // Add total row
  const totalAmount = document.getElementById("totalAmount").textContent.trim();
  data.push(["", "", "Total", parseFloat(totalAmount)]);

  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "ClientDatabase");

  const dateStr = dayjs().format('DD-MM-YYYY');
  XLSX.writeFile(wb, `client_database_${dateStr}.xlsx`);
});


    document.getElementById("applyFilterBtn").addEventListener("click", () => {
      const nameFilter = document.getElementById("filterName").value.trim().toLowerCase();
      const startDate = document.getElementById("filterStartDate").value;
      const endDate = document.getElementById("filterEndDate").value;

      tbody.querySelectorAll("tr").forEach(row => {
        const name = row.querySelector("td:nth-child(3) input").value.trim().toLowerCase();
        const dateVal = row.querySelector("td:nth-child(4) input").value;
        const show =
          name.includes(nameFilter) &&
          (!startDate || dateVal >= startDate) &&
          (!endDate || dateVal <= endDate);
        row.style.display = show ? "" : "none";
      });
    });

    document.getElementById("clearFilterBtn").addEventListener("click", () => {
      document.getElementById("filterName").value = '';
      document.getElementById("filterStartDate").value = '';
      document.getElementById("filterEndDate").value = '';
      tbody.querySelectorAll("tr").forEach(row => (row.style.display = ""));
    });

    loadRows();
  </script>
   <script>
    const filterBtn = document.getElementById('filterBtn');
    const filterPanel = document.getElementById('filterPanel');
    const arrow = document.getElementById('arrow');

    filterBtn.addEventListener('click', () => {
      const isCollapsed = filterPanel.classList.contains('collapsed');
      filterPanel.classList.toggle('collapsed', !isCollapsed);
      filterPanel.classList.toggle('expanded', isCollapsed);
      arrow.textContent = isCollapsed ? '▲' : '▼';
    });
  </script>
  <script>// Search input live filter
document.getElementById('searchInput').addEventListener('input', () => {
  const searchValue = document.getElementById('searchInput').value.trim().toLowerCase();

  tbody.querySelectorAll('tr').forEach(row => {
    const nameInput = row.querySelector('td:nth-child(3) input');
    const name = nameInput ? nameInput.value.toLowerCase() : '';
    const matchesSearch = name.includes(searchValue);
    const isVisibleByFilterPanel = row.style.display !== 'none';
    row.style.display = matchesSearch && isVisibleByFilterPanel ? '' : 'none';
  });
});

// Existing filter panel logic (for reference)
document.getElementById("applyFilterBtn").addEventListener("click", () => {
  const nameFilter = document.getElementById("filterName").value.trim().toLowerCase();
  const startDate = document.getElementById("filterStartDate").value;
  const endDate = document.getElementById("filterEndDate").value;

  tbody.querySelectorAll("tr").forEach(row => {
    const name = row.querySelector("td:nth-child(3) input").value.trim().toLowerCase();
    const dateVal = row.querySelector("td:nth-child(4) input").value;
    const show =
      name.includes(nameFilter) &&
      (!startDate || dateVal >= startDate) &&
      (!endDate || dateVal <= endDate);
    row.style.display = show ? "" : "none";
  });

  // Trigger search to respect current search input after filtering
  document.getElementById('searchInput').dispatchEvent(new Event('input'));
});

document.getElementById("clearFilterBtn").addEventListener("click", () => {
  document.getElementById("filterName").value = '';
  document.getElementById("filterStartDate").value = '';
  document.getElementById("filterEndDate").value = '';
  tbody.querySelectorAll("tr").forEach(row => (row.style.display = ""));
  
  // Trigger search to re-apply search filtering after clearing filters
  document.getElementById('searchInput').dispatchEvent(new Event('input'));
});
</script>

</body>
</html>
